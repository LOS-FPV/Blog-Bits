name: Deploy New Posts to Astro Blog

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * *'  # Every day at 06:00 UTC

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # allow pushing commits to the repo
    env:
      # Use repository secrets for tokens/URLs (injected as env vars)
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main   # ensure we're on the main branch (especially for schedule)
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install Dependencies
        run: npm ci

      - name: Generate New Post
        run: npm run generate-post

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "[emailÂ protected]"
          git add -A
          # Commit and push only if there are changes (new posts)
          if [ -z "$(git status --porcelain)" ]; then
            echo "No new posts to commit."
          else
            git commit -m "chore: add new generated posts [skip ci]"
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
            echo "NEW_POSTS=true" >> $GITHUB_ENV
          fi

      - name: Trigger Vercel Deployment
        if: env.NEW_POSTS == 'true'
        run: |
          # Invoke Vercel deploy hook to trigger a new deployment
          curl -X POST -fsS "$VERCEL_DEPLOY_HOOK_URL"
