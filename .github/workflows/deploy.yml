name: Generate & Deploy Blog Post

on:
  schedule:
    - cron: '0 1,13 * * *'  # 01:00 and 13:00 UTC
  workflow_dispatch:

jobs:
  generate-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Create SSH directory
        run: mkdir -p ~/.ssh && chmod 700 ~/.ssh

      - name: Add SSH key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add GitHub to known_hosts
        run: ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Configure Git identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: Generate new blog post
        run: npm run generate-post

      - name: Commit changes
        run: |
          git add content/posts
          git commit -m "Auto post: $(date -u)" || echo "No changes to commit"

      - name: Push to GitHub
        run: git push git@github.com:LOS-FPV/Blog-Bits.git HEAD:main

      - name: Trigger Vercel redeploy
        if: success()
        run: |
          curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
